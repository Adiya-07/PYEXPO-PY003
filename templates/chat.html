{% extends "base.html" %}

{% block content %}
<section style="padding: 2rem;">
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-avatar">ğŸ”®</div>
            <div class="chat-info">
                <h3>AstroGuy AI</h3>
                <p>Your Personal Vedic Astrologer</p>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message message-bot">
                ğŸ™ {{ 'à®µà®£à®•à¯à®•à®®à¯! à®¨à®¾à®©à¯ à®†à®¸à¯à®Ÿà¯à®°à¯‹à®•à¯ˆ AI, à®‰à®™à¯à®•à®³à¯ à®µà¯‡à®¤ à®œà¯‹à®¤à®¿à®Ÿ à®‰à®¤à®µà®¿à®¯à®¾à®³à®°à¯. à®‡à®©à¯à®±à¯ à®¨à®¾à®©à¯ à®‰à®™à¯à®•à®³à¯à®•à¯à®•à¯ à®à®ªà¯à®ªà®Ÿà®¿ à®‰à®¤à®µ à®®à¯à®Ÿà®¿à®¯à¯à®®à¯?' if language == 'ta' else "Vanakkam! I'm AstroGuy AI, your Vedic astrology assistant. How may I assist you today?" }}
            </div>
        </div>
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" 
                   placeholder="{{ 'à®‰à®™à¯à®•à®³à¯ à®¤à¯Šà®´à®¿à®²à¯, à®•à®¾à®¤à®²à¯ à®µà®¾à®´à¯à®•à¯à®•à¯ˆ, à®ªà®°à®¿à®•à®¾à®°à®™à¯à®•à®³à¯ à®ªà®±à¯à®±à®¿ à®•à¯‡à®³à¯à®™à¯à®•à®³à¯...' if language == 'ta' else 'Ask about your career, love life, remedies...' }}"
                   onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="chat-send" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;
    
    const messagesDiv = document.getElementById('chatMessages');
    const typing = document.getElementById('typingIndicator');
    
    // Add user message
    messagesDiv.innerHTML += `<div class="message message-user">${escapeHtml(message)}</div>`;
    input.value = '';
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    // Show typing indicator
    typing.classList.add('active');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
        
        const data = await response.json();
        
        // Hide typing indicator
        typing.classList.remove('active');
        
        if (data.success) {
            messagesDiv.innerHTML += `<div class="message message-bot">${data.response}</div>`;
        } else {
            messagesDiv.innerHTML += `<div class="message message-bot">Sorry, I encountered an error. Please try again.</div>`;
        }
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    } catch (error) {
        typing.classList.remove('active');
        messagesDiv.innerHTML += `<div class="message message-bot">Sorry, I encountered an error. Please try again.</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
