{% extends "base.html" %}

{% block content %}
<div class="chat-wrap">

    <!-- Header -->
    <div class="chat-header">
        <div class="chat-avatar-wrap">
            <div class="chat-avatar">ğŸ”®</div>
            <div class="chat-online-dot"></div>
        </div>
        <div class="chat-info">
            <h3 class="chat-name">AstroGuy AI</h3>
            <p class="chat-sub">
                {% if language == 'ta' %}à®‰à®™à¯à®•à®³à¯ à®¤à®©à®¿à®ªà¯à®ªà®Ÿà¯à®Ÿ à®µà¯‡à®¤ à®œà¯‹à®¤à®¿à®Ÿ à®µà®´à®¿à®•à®¾à®Ÿà¯à®Ÿà®¿{% else %}Your Personal Vedic Astrologer{%
                endif %}
                <span class="ml-badge"><i class="fas fa-microchip"></i> ML-Powered</span>
            </p>
        </div>
    </div>

    <!-- Messages area -->
    <div class="chat-messages" id="chatMessages">
        <div class="message message-bot">
            {% if language == 'ta' %}
            ğŸ™ à®µà®£à®•à¯à®•à®®à¯! à®¨à®¾à®©à¯ AstroGuy AI. à®‰à®™à¯à®•à®³à¯ à®°à®¾à®šà®¿, à®¨à®Ÿà¯à®šà®¤à¯à®¤à®¿à®°à®®à¯, à®¤à®¿à®°à¯à®®à®£ à®ªà¯Šà®°à¯à®¤à¯à®¤à®®à¯, à®¤à¯Šà®´à®¿à®²à¯, à®•à®¾à®¤à®²à¯ à®…à®²à¯à®²à®¤à¯ à®ªà®°à®¿à®•à®¾à®°à®™à¯à®•à®³à¯
            à®ªà®±à¯à®±à®¿ à®•à¯‡à®Ÿà¯à®•à®²à®¾à®®à¯!
            {% else %}
            ğŸ™ Vanakkam! I'm AstroGuy AI, your Vedic astrology assistant. Ask me about your Rasi, Nakshatra,
            compatibility, career, love, or remedies!
            {% endif %}
        </div>
    </div>

    <!-- Typing indicator -->
    <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
    </div>

    <!-- Quick Replies -->
    <div class="quick-replies" id="quickReplies">
        <div class="quick-replies-header">
            <span>âœ¨</span>
            <span>{% if language == 'ta' %}à®µà®¿à®°à¯ˆà®µà¯ à®•à¯‡à®³à¯à®µà®¿à®•à®³à¯{% else %}Quick Questions{% endif %}</span>
        </div>
        <div class="quick-replies-grid" id="quickRepliesGrid"></div>
    </div>

    <!-- Input -->
    <div class="chat-input-container">
        <input type="text" class="chat-input" id="chatInput"
            placeholder="{% if language == 'ta' %}à®°à®¾à®šà®¿, à®¤à®¿à®°à¯à®®à®£à®®à¯, à®¤à¯Šà®´à®¿à®²à¯, à®ªà®°à®¿à®•à®¾à®°à®®à¯ à®ªà®±à¯à®±à®¿ à®•à¯‡à®³à¯à®™à¯à®•à®³à¯...{% else %}Ask about Rasi, marriage, career, remedies...{% endif %}"
            onkeypress="if(event.key==='Enter') sendMessage()" autocomplete="off">
        <button class="chat-send" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>

</div>

<style>
    /* â”€â”€ Wrap â”€â”€ */
    .chat-wrap {
        max-width: 780px;
        margin: 0 auto;
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
        padding: 1rem 1rem 0.8rem;
        gap: 0.8rem;
    }

    /* â”€â”€ Header â”€â”€ */
    .chat-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 1.4rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 215, 0, 0.12);
        border-radius: 16px;
        flex-shrink: 0;
    }

    .chat-avatar-wrap {
        position: relative;
        flex-shrink: 0;
    }

    .chat-avatar {
        width: 46px;
        height: 46px;
        background: rgba(255, 215, 0, 0.1);
        border: 1.5px solid rgba(255, 215, 0, 0.3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
    }

    .chat-online-dot {
        position: absolute;
        bottom: 1px;
        right: 1px;
        width: 10px;
        height: 10px;
        background: #3DD68C;
        border-radius: 50%;
        border: 2px solid #050510;
    }

    .chat-name {
        font-family: 'Cinzel', serif;
        font-size: 1rem;
        color: #FFD700;
        margin: 0 0 0.25rem;
    }

    .chat-sub {
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.78rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.6rem;
        flex-wrap: wrap;
    }

    .ml-badge {
        background: rgba(255, 215, 0, 0.1);
        border: 1px solid rgba(255, 215, 0, 0.2);
        color: rgba(255, 215, 0, 0.8);
        padding: 0.15rem 0.5rem;
        border-radius: 20px;
        font-size: 0.72rem;
    }

    /* â”€â”€ Messages â”€â”€ */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.9rem;
        padding: 0.4rem 0.2rem;
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 215, 0, 0.15) transparent;
    }

    .chat-messages::-webkit-scrollbar {
        width: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(255, 215, 0, 0.2);
        border-radius: 4px;
    }

    .message {
        max-width: 70%;
        padding: 0.9rem 1.2rem;
        border-radius: 18px;
        font-size: 0.92rem;
        line-height: 1.75;
        animation: msgIn 0.28s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .message-bot {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 215, 0, 0.1);
        border-bottom-left-radius: 4px;
        color: rgba(255, 255, 255, 0.85);
        align-self: flex-start;
    }

    .message-user {
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.16), rgba(255, 140, 0, 0.1));
        border: 1px solid rgba(255, 215, 0, 0.22);
        border-bottom-right-radius: 4px;
        color: #fff;
        align-self: flex-end;
    }

    @keyframes msgIn {
        from {
            opacity: 0;
            transform: translateY(8px) scale(0.96);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* â”€â”€ Typing â”€â”€ */
    .typing-indicator {
        display: none;
        align-items: center;
        gap: 5px;
        padding: 0.1rem 0.3rem;
        flex-shrink: 0;
    }

    .typing-indicator.active {
        display: flex;
    }

    .typing-dot {
        width: 7px;
        height: 7px;
        background: rgba(255, 215, 0, 0.45);
        border-radius: 50%;
        animation: bounce 1.2s ease-in-out infinite;
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes bounce {

        0%,
        60%,
        100% {
            transform: translateY(0);
            opacity: 0.4;
        }

        30% {
            transform: translateY(-7px);
            opacity: 1;
        }
    }

    /* â”€â”€ Quick Replies â”€â”€ */
    .quick-replies {
        flex-shrink: 0;
        border-top: 1px solid rgba(255, 215, 0, 0.08);
        padding-top: 0.8rem;
    }

    .quick-replies-header {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.72rem;
        color: rgba(255, 255, 255, 0.35);
        font-weight: 600;
        letter-spacing: 0.8px;
        text-transform: uppercase;
        margin-bottom: 0.65rem;
    }

    .quick-replies-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
    }

    .quick-reply-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.42rem 0.85rem;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 215, 0, 0.14);
        border-radius: 50px;
        color: rgba(255, 255, 255, 0.65);
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .quick-reply-btn:hover {
        background: rgba(255, 215, 0, 0.09);
        border-color: rgba(255, 215, 0, 0.38);
        color: #FFD700;
        transform: translateY(-2px);
    }

    .quick-reply-icon {
        font-size: 1rem;
    }

    /* â”€â”€ Input â”€â”€ */
    .chat-input-container {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.7rem 1rem;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 215, 0, 0.15);
        border-radius: 50px;
        flex-shrink: 0;
        transition: border-color 0.2s, background 0.2s;
    }

    .chat-input-container:focus-within {
        border-color: rgba(255, 215, 0, 0.38);
        background: rgba(255, 255, 255, 0.06);
    }

    .chat-input {
        flex: 1;
        background: none;
        border: none;
        outline: none;
        color: #fff;
        font-size: 0.92rem;
        min-width: 0;
    }

    .chat-input::placeholder {
        color: rgba(255, 255, 255, 0.28);
    }

    .chat-send {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #FFD700, #FF8C00);
        border: none;
        border-radius: 50%;
        color: #000;
        font-size: 0.85rem;
        cursor: pointer;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .chat-send:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 16px rgba(255, 215, 0, 0.35);
    }

    @media (max-width: 600px) {
        .message {
            max-width: 86%;
            font-size: 0.88rem;
        }

        .chat-wrap {
            padding: 0.6rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    const LANG = "{{ language }}";
    let userChart = null;
    const QUICK_REPLIES = {
        en: [
            { icon: "ğŸŒ™", text: "My Rasi", query: "what is my rasi" },
            { icon: "â­", text: "My Nakshatra", query: "what is my nakshatra" },
            { icon: "ğŸ“…", text: "Today's forecast", query: "how will my day be" },
            { icon: "ğŸ’¼", text: "Career", query: "career advice" },
            { icon: "ğŸ’•", text: "Love & marriage", query: "marriage prediction" },
            { icon: "ğŸ’°", text: "Finance", query: "money prediction" },
            { icon: "ğŸ•‰ï¸", text: "Remedies", query: "remedy for planets" },
            { icon: "â˜€ï¸", text: "About Sun", query: "tell me about sun" },
            { icon: "ğŸª", text: "About Saturn", query: "tell me about saturn" },
            { icon: "ğŸ”®", text: "What is Dasha?", query: "what is dasha" },
        ],
        ta: [
            { icon: "ğŸŒ™", text: "à®à®©à¯ à®°à®¾à®šà®¿", query: "à®°à®¾à®šà®¿ à®à®©à¯à®©" },
            { icon: "â­", text: "à®¨à®Ÿà¯à®šà®¤à¯à®¤à®¿à®°à®®à¯", query: "à®¨à®Ÿà¯à®šà®¤à¯à®¤à®¿à®°à®®à¯ à®à®©à¯à®©" },
            { icon: "ğŸ“…", text: "à®‡à®©à¯à®±à¯ˆà®¯ à®ªà®²à®©à¯", query: "à®‡à®©à¯à®±à¯ à®à®ªà¯à®ªà®Ÿà®¿ à®‡à®°à¯à®•à¯à®•à¯à®®à¯" },
            { icon: "ğŸ’¼", text: "à®¤à¯Šà®´à®¿à®²à¯", query: "à®¤à¯Šà®´à®¿à®²à¯ à®ªà®²à®©à¯" },
            { icon: "ğŸ’•", text: "à®•à®¾à®¤à®²à¯ & à®¤à®¿à®°à¯à®®à®£à®®à¯", query: "à®¤à®¿à®°à¯à®®à®£ à®ªà®²à®©à¯" },
            { icon: "ğŸ’°", text: "à®¨à®¿à®¤à®¿", query: "à®ªà®£à®®à¯ à®ªà®²à®©à¯" },
            { icon: "ğŸ•‰ï¸", text: "à®ªà®°à®¿à®•à®¾à®°à®™à¯à®•à®³à¯", query: "à®ªà®°à®¿à®•à®¾à®°à®®à¯" },
            { icon: "â˜€ï¸", text: "à®šà¯‚à®°à®¿à®¯à®©à¯", query: "à®šà¯‚à®°à®¿à®¯à®©à¯ à®ªà®±à¯à®±à®¿" },
            { icon: "ğŸª", text: "à®šà®©à®¿ à®ªà®±à¯à®±à®¿", query: "à®šà®©à®¿ à®ªà®±à¯à®±à®¿" },
            { icon: "ğŸ”®", text: "à®¤à®šà¯ˆ à®à®©à¯à®©?", query: "à®¤à®šà¯ˆ à®à®©à¯à®©" },
        ]
    };

    // Load user chart
    (async function loadUserData() {
        try {
            const res = await fetch('/api/get-user-data');
            const data = await res.json();
            if (data.chart) userChart = data.chart;
        } catch (e) { }
        initQuickReplies();
    })();

    function initQuickReplies() {
        const grid = document.getElementById('quickRepliesGrid');
        const replies = QUICK_REPLIES[LANG] || QUICK_REPLIES.en;
        grid.innerHTML = replies.map(r =>
            `<button class="quick-reply-btn" onclick="sendQuickReply('${r.query.replace(/'/g, "\\'")}')">
            <span class="quick-reply-icon">${r.icon}</span>
            <span>${r.text}</span>
         </button>`
        ).join('');
    }

    function sendQuickReply(query) {
        document.getElementById('chatInput').value = query;
        sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        const messagesDiv = document.getElementById('chatMessages');
        const typing = document.getElementById('typingIndicator');

        appendMessage(message, 'user');
        input.value = '';


        typing.classList.add('active');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, lang: LANG, userChart })
            });
            const data = await res.json();
            typing.classList.remove('active');
            appendMessage(data.success ? data.response :
                (LANG === 'ta' ? 'à®®à®©à¯à®©à®¿à®•à¯à®•à®µà¯à®®à¯, à®’à®°à¯ à®ªà®¿à®´à¯ˆ à®à®±à¯à®ªà®Ÿà¯à®Ÿà®¤à¯.' : 'Sorry, an error occurred. Please try again.'),
                'bot');
        } catch (err) {
            typing.classList.remove('active');
            appendMessage(LANG === 'ta'
                ? 'à®‡à®£à¯ˆà®ªà¯à®ªà¯ à®ªà®¿à®´à¯ˆ. Flask à®šà®°à¯à®µà®°à¯ à®‡à®¯à®™à¯à®•à¯à®•à®¿à®±à®¤à®¾ à®à®© à®šà®°à®¿à®ªà®¾à®°à¯à®•à¯à®•à®µà¯à®®à¯.'
                : 'Connection error. Please check if the Flask server is running.', 'bot');
        }
    }

    function appendMessage(text, role) {
        const div = document.createElement('div');
        div.className = `message message-${role}`;
        div.textContent = text;
        const msgs = document.getElementById('chatMessages');
        msgs.appendChild(div);
        msgs.scrollTop = msgs.scrollHeight;
    }
</script>
{% endblock %}