{% extends "base.html" %}

{% block content %}
<section style="padding: 1rem 2rem;">
    <div class="chat-container">

        <!-- Header -->
        <div class="chat-header">
            <div class="chat-avatar">ğŸ”®</div>
            <div class="chat-info">
                <h3>AstroGuy AI</h3>
                <p>
                    {% if language == 'ta' %}
                    à®‰à®™à¯à®•à®³à¯ à®¤à®©à®¿à®ªà¯à®ªà®Ÿà¯à®Ÿ à®µà¯‡à®¤ à®œà¯‹à®¤à®¿à®Ÿ à®µà®´à®¿à®•à®¾à®Ÿà¯à®Ÿà®¿
                    {% else %}
                    Your Personal Vedic Astrologer
                    {% endif %}
                    <span class="ml-badge">
                        <i class="fas fa-microchip"></i> ML-Powered
                    </span>
                </p>
            </div>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="chatMessages">
            <div class="message message-bot">
                {% if language == 'ta' %}
                ğŸ™ à®µà®£à®•à¯à®•à®®à¯! à®¨à®¾à®©à¯ AstroGuy AI. à®‰à®™à¯à®•à®³à¯ à®°à®¾à®šà®¿, à®¨à®Ÿà¯à®šà®¤à¯à®¤à®¿à®°à®®à¯, à®¤à®¿à®°à¯à®®à®£ à®ªà¯Šà®°à¯à®¤à¯à®¤à®®à¯, à®¤à¯Šà®´à®¿à®²à¯, à®•à®¾à®¤à®²à¯ à®…à®²à¯à®²à®¤à¯
                à®ªà®°à®¿à®•à®¾à®°à®™à¯à®•à®³à¯ à®ªà®±à¯à®±à®¿ à®•à¯‡à®Ÿà¯à®•à®²à®¾à®®à¯!
                {% else %}
                ğŸ™ Vanakkam! I'm AstroGuy AI, your Vedic astrology assistant. Ask me about your Rasi, Nakshatra,
                compatibility, career, love, or remedies!
                {% endif %}
            </div>
        </div>

        <!-- Typing indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>

        <!-- Quick Replies -->
        <div class="quick-replies" id="quickReplies">
            <div class="quick-replies-header">
                <span class="quick-replies-icon">âœ¨</span>
                <span class="quick-replies-title">{% if language == 'ta' %}à®µà®¿à®°à¯ˆà®µà¯ à®•à¯‡à®³à¯à®µà®¿à®•à®³à¯{% else %}Quick Questions{%
                    endif %}</span>
            </div>
            <div class="quick-replies-grid" id="quickRepliesGrid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Input -->
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput"
                placeholder="{% if language == 'ta' %}à®°à®¾à®šà®¿, à®¤à®¿à®°à¯à®®à®£à®®à¯, à®¤à¯Šà®´à®¿à®²à¯, à®ªà®°à®¿à®•à®¾à®°à®®à¯ à®ªà®±à¯à®±à®¿ à®•à¯‡à®³à¯à®™à¯à®•à®³à¯...{% else %}Ask about Rasi, marriage, career, remedies...{% endif %}"
                onkeypress="if(event.key==='Enter') sendMessage()" autocomplete="off">
            <button class="chat-send" onclick="sendMessage()" title="Send">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>

    </div>
</section>

<style>
    /* Quick Replies */
    .quick-replies {
        padding: 0 1.5rem 1rem;
        background: rgba(0, 0, 0, 0.2);
        border-top: 1px solid rgba(255, 215, 0, 0.1);
    }

    .quick-replies-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.8rem 0 0.6rem;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.85rem;
    }

    .quick-replies-icon {
        font-size: 1rem;
    }

    .quick-replies-title {
        font-weight: 600;
    }

    .quick-replies-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 0.6rem;
    }

    .quick-reply-btn {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 215, 0, 0.2);
        border-radius: 20px;
        padding: 0.6rem 1rem;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .quick-reply-btn:hover {
        background: rgba(255, 215, 0, 0.1);
        border-color: rgba(255, 215, 0, 0.4);
        transform: translateY(-2px);
        color: #FFD700;
    }

    .quick-reply-btn:active {
        transform: translateY(0);
    }

    .quick-reply-icon {
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    @media (max-width: 768px) {
        .quick-replies-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 480px) {
        .quick-replies-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

{% endblock %}

{% block extra_js %}
<script>
    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const LANG = "{{ language }}";
    let userChart = null;

    // â”€â”€ Quick Reply Options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const QUICK_REPLIES = {
        en: [
            { icon: "ğŸŒ™", text: "Tell me about my Rasi", query: "Tell me about my rasi" },
            { icon: "â­", text: "My Nakshatra details", query: "What is my nakshatra?" },
            { icon: "ğŸ’¼", text: "Career guidance", query: "Give me career advice" },
            { icon: "ğŸ’•", text: "Love & marriage", query: "When will I get married?" },
            { icon: "ğŸ’°", text: "Financial advice", query: "Tell me about my finances" },
            { icon: "ğŸ•‰ï¸", text: "Remedies for me", query: "What remedies should I do?" },
            { icon: "â˜€ï¸", text: "About Sun", query: "Tell me about the Sun" },
            { icon: "ğŸŒ™", text: "About Moon", query: "Tell me about the Moon" },
        ],
        ta: [
            { icon: "ğŸŒ™", text: "à®à®©à¯ à®°à®¾à®šà®¿ à®ªà®±à¯à®±à®¿", query: "à®à®©à¯ à®°à®¾à®šà®¿ à®ªà®±à¯à®±à®¿ à®šà¯Šà®²à¯à®²à¯à®™à¯à®•à®³à¯" },
            { icon: "â­", text: "à®¨à®Ÿà¯à®šà®¤à¯à®¤à®¿à®° à®µà®¿à®µà®°à®®à¯", query: "à®à®©à¯ à®¨à®Ÿà¯à®šà®¤à¯à®¤à®¿à®°à®®à¯ à®à®©à¯à®©?" },
            { icon: "ğŸ’¼", text: "à®¤à¯Šà®´à®¿à®²à¯ à®µà®´à®¿à®•à®¾à®Ÿà¯à®Ÿà¯à®¤à®²à¯", query: "à®¤à¯Šà®´à®¿à®²à¯ à®†à®²à¯‹à®šà®©à¯ˆ à®•à¯Šà®Ÿà¯à®™à¯à®•à®³à¯" },
            { icon: "ğŸ’•", text: "à®•à®¾à®¤à®²à¯ & à®¤à®¿à®°à¯à®®à®£à®®à¯", query: "à®à®ªà¯à®ªà¯‹à®¤à¯ à®¤à®¿à®°à¯à®®à®£à®®à¯ à®†à®•à¯à®®à¯?" },
            { icon: "ğŸ’°", text: "à®¨à®¿à®¤à®¿ à®†à®²à¯‹à®šà®©à¯ˆ", query: "à®¨à®¿à®¤à®¿ à®ªà®±à¯à®±à®¿ à®šà¯Šà®²à¯à®²à¯à®™à¯à®•à®³à¯" },
            { icon: "ğŸ•‰ï¸", text: "à®ªà®°à®¿à®•à®¾à®°à®™à¯à®•à®³à¯", query: "à®à®©à¯à®© à®ªà®°à®¿à®•à®¾à®°à®®à¯ à®šà¯†à®¯à¯à®¯à®²à®¾à®®à¯?" },
            { icon: "â˜€ï¸", text: "à®šà¯‚à®°à®¿à®¯à®©à¯ à®ªà®±à¯à®±à®¿", query: "à®šà¯‚à®°à®¿à®¯à®©à¯ à®ªà®±à¯à®±à®¿ à®šà¯Šà®²à¯à®²à¯à®™à¯à®•à®³à¯" },
            { icon: "ğŸŒ™", text: "à®šà®¨à¯à®¤à®¿à®°à®©à¯ à®ªà®±à¯à®±à®¿", query: "à®šà®¨à¯à®¤à®¿à®°à®©à¯ à®ªà®±à¯à®±à®¿ à®šà¯Šà®²à¯à®²à¯à®™à¯à®•à®³à¯" },
        ]
    };

    // â”€â”€ Load user chart from session on page load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (async function loadUserData() {
        try {
            const res = await fetch('/api/get-user-data');
            const data = await res.json();
            if (data.chart) {
                userChart = data.chart;
                console.log('User chart loaded:', userChart.rasi?.english_name || userChart.rasi?.englishName);
            }
        } catch (e) {
            console.log('No user chart in session');
        }

        // Initialize quick replies
        initQuickReplies();
    })();

    // â”€â”€ Initialize Quick Replies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function initQuickReplies() {
        const grid = document.getElementById('quickRepliesGrid');
        const replies = QUICK_REPLIES[LANG] || QUICK_REPLIES.en;

        grid.innerHTML = replies.map(reply => `
        <button class="quick-reply-btn" onclick="sendQuickReply('${reply.query.replace(/'/g, "\\'")}')">
            <span class="quick-reply-icon">${reply.icon}</span>
            <span>${reply.text}</span>
        </button>
    `).join('');
    }

    // â”€â”€ Send Quick Reply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sendQuickReply(query) {
        document.getElementById('chatInput').value = query;
        sendMessage();
    }

    // â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;

        const messagesDiv = document.getElementById('chatMessages');
        const typing = document.getElementById('typingIndicator');

        // Show user message
        appendMessage(message, 'user');
        input.value = '';

        // Show typing
        typing.classList.add('active');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    lang: LANG,
                    userChart: userChart     // â† sends chart to Python for personalised replies
                })
            });

            const data = await res.json();
            typing.classList.remove('active');

            if (data.success) {
                appendMessage(data.response, 'bot');
            } else {
                appendMessage(
                    LANG === 'ta'
                        ? 'à®®à®©à¯à®©à®¿à®•à¯à®•à®µà¯à®®à¯, à®’à®°à¯ à®ªà®¿à®´à¯ˆ à®à®±à¯à®ªà®Ÿà¯à®Ÿà®¤à¯. à®®à¯€à®£à¯à®Ÿà¯à®®à¯ à®®à¯à®¯à®±à¯à®šà®¿à®•à¯à®•à®µà¯à®®à¯.'
                        : 'Sorry, I encountered an error. Please try again.',
                    'bot'
                );
            }

        } catch (err) {
            typing.classList.remove('active');
            appendMessage(
                LANG === 'ta'
                    ? 'à®‡à®£à¯ˆà®ªà¯à®ªà¯ à®ªà®¿à®´à¯ˆ. Flask à®šà®°à¯à®µà®°à¯ à®‡à®¯à®™à¯à®•à¯à®•à®¿à®±à®¤à®¾ à®à®© à®šà®°à®¿à®ªà®¾à®°à¯à®•à¯à®•à®µà¯à®®à¯.'
                    : 'Connection error. Please check if the Flask server is running.',
                'bot'
            );
        }
    }

    // â”€â”€ Append a message bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function appendMessage(text, role) {
        const messagesDiv = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = `message message-${role}`;
        div.textContent = text;   // textContent prevents XSS
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
{% endblock %}