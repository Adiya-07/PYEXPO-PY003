{% extends "base.html" %}

{% block content %}
<section style="padding: 1rem 2rem;">
    <div class="chat-container">

        <!-- Header -->
        <div class="chat-header">
            <div class="chat-avatar">ğŸ”®</div>
            <div class="chat-info">
                <h3>AstroGuy AI</h3>
                <p>
                    {% if language == 'ta' %}
                        à®‰à®™à¯à®•à®³à¯ à®¤à®©à®¿à®ªà¯à®ªà®Ÿà¯à®Ÿ à®µà¯‡à®¤ à®œà¯‹à®¤à®¿à®Ÿ à®µà®´à®¿à®•à®¾à®Ÿà¯à®Ÿà®¿
                    {% else %}
                        Your Personal Vedic Astrologer
                    {% endif %}
                    <span class="ml-badge">
                        <i class="fas fa-microchip"></i> ML-Powered
                    </span>
                </p>
            </div>
        </div>

        <!-- Messages -->
        <div class="chat-messages" id="chatMessages">
            <div class="message message-bot">
                {% if language == 'ta' %}
                    ğŸ™ à®µà®£à®•à¯à®•à®®à¯! à®¨à®¾à®©à¯ AstroGuy AI. à®‰à®™à¯à®•à®³à¯ à®°à®¾à®šà®¿, à®¨à®Ÿà¯à®šà®¤à¯à®¤à®¿à®°à®®à¯, à®¤à®¿à®°à¯à®®à®£ à®ªà¯Šà®°à¯à®¤à¯à®¤à®®à¯, à®¤à¯Šà®´à®¿à®²à¯, à®•à®¾à®¤à®²à¯ à®…à®²à¯à®²à®¤à¯ à®ªà®°à®¿à®•à®¾à®°à®™à¯à®•à®³à¯ à®ªà®±à¯à®±à®¿ à®•à¯‡à®Ÿà¯à®•à®²à®¾à®®à¯!
                {% else %}
                    ğŸ™ Vanakkam! I'm AstroGuy AI, your Vedic astrology assistant. Ask me about your Rasi, Nakshatra, compatibility, career, love, or remedies!
                {% endif %}
            </div>
        </div>

        <!-- Typing indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>

        <!-- Input -->
        <div class="chat-input-container">
            <input
                type="text"
                class="chat-input"
                id="chatInput"
                placeholder="{% if language == 'ta' %}à®°à®¾à®šà®¿, à®¤à®¿à®°à¯à®®à®£à®®à¯, à®¤à¯Šà®´à®¿à®²à¯, à®ªà®°à®¿à®•à®¾à®°à®®à¯ à®ªà®±à¯à®±à®¿ à®•à¯‡à®³à¯à®™à¯à®•à®³à¯...{% else %}Ask about Rasi, marriage, career, remedies...{% endif %}"
                onkeypress="if(event.key==='Enter') sendMessage()"
                autocomplete="off"
            >
            <button class="chat-send" onclick="sendMessage()" title="Send">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>

    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LANG = "{{ language }}";
let userChart = null;

// â”€â”€ Load user chart from session on page load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function loadUserData() {
    try {
        const res  = await fetch('/api/get-user-data');
        const data = await res.json();
        if (data.chart) {
            userChart = data.chart;
            console.log('User chart loaded:', userChart.rasi?.english_name || userChart.rasi?.englishName);
        }
    } catch (e) {
        console.log('No user chart in session');
    }
})();

// â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
    const input      = document.getElementById('chatInput');
    const message    = input.value.trim();
    if (!message) return;

    const messagesDiv = document.getElementById('chatMessages');
    const typing      = document.getElementById('typingIndicator');

    // Show user message
    appendMessage(message, 'user');
    input.value = '';

    // Show typing
    typing.classList.add('active');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    try {
        const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message:   message,
                lang:      LANG,
                userChart: userChart     // â† sends chart to Python for personalised replies
            })
        });

        const data = await res.json();
        typing.classList.remove('active');

        if (data.success) {
            appendMessage(data.response, 'bot');
        } else {
            appendMessage(
                LANG === 'ta'
                    ? 'à®®à®©à¯à®©à®¿à®•à¯à®•à®µà¯à®®à¯, à®’à®°à¯ à®ªà®¿à®´à¯ˆ à®à®±à¯à®ªà®Ÿà¯à®Ÿà®¤à¯. à®®à¯€à®£à¯à®Ÿà¯à®®à¯ à®®à¯à®¯à®±à¯à®šà®¿à®•à¯à®•à®µà¯à®®à¯.'
                    : 'Sorry, I encountered an error. Please try again.',
                'bot'
            );
        }

    } catch (err) {
        typing.classList.remove('active');
        appendMessage(
            LANG === 'ta'
                ? 'à®‡à®£à¯ˆà®ªà¯à®ªà¯ à®ªà®¿à®´à¯ˆ. Flask à®šà®°à¯à®µà®°à¯ à®‡à®¯à®™à¯à®•à¯à®•à®¿à®±à®¤à®¾ à®à®© à®šà®°à®¿à®ªà®¾à®°à¯à®•à¯à®•à®µà¯à®®à¯.'
                : 'Connection error. Please check if the Flask server is running.',
            'bot'
        );
    }
}

// â”€â”€ Append a message bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendMessage(text, role) {
    const messagesDiv = document.getElementById('chatMessages');
    const div         = document.createElement('div');
    div.className     = `message message-${role}`;
    div.textContent   = text;   // textContent prevents XSS
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
</script>
{% endblock %}
