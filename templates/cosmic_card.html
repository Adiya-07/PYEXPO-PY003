{% extends "base.html" %}

{% block content %}
<section
    style="padding:2rem 1rem;max-width:700px;margin:0 auto;min-height:calc(100vh - 80px);display:flex;flex-direction:column;justify-content:center">

    <div style="text-align:center;margin-bottom:2.5rem">
        <div style="font-size:3rem;margin-bottom:0.8rem;animation:float 3s ease-in-out infinite">ğŸ´</div>
        <h1 style="font-family:'Cinzel',serif;color:#FFD700;font-size:2rem;margin-bottom:0.5rem;font-weight:700">
            {% if language == 'ta' %}à®‰à®™à¯à®•à®³à¯ à®ªà®¿à®°à®ªà®à¯à®š à®…à®Ÿà¯à®Ÿà¯ˆ{% else %}Your Cosmic Card{% endif %}
        </h1>
        <p style="color:rgba(255,255,255,0.5);font-size:0.95rem;line-height:1.6">
            {% if language == 'ta' %}
            à®‰à®™à¯à®•à®³à¯ à®¤à®©à®¿à®ªà¯à®ªà®Ÿà¯à®Ÿ à®œà¯‹à®¤à®¿à®Ÿ à®…à®Ÿà¯ˆà®¯à®¾à®³ à®…à®Ÿà¯à®Ÿà¯ˆ
            {% else %}
            Your personal astrology identity card
            {% endif %}
        </p>
    </div>

    {% if not user_chart %}
    <!-- No chart yet -->
    <div style="text-align:center;padding:3rem 2rem;background:rgba(255,255,255,0.04);
                border:1px dashed rgba(255,215,0,0.3);border-radius:20px;animation:fadeIn 0.5s ease">
        <div style="font-size:4rem;margin-bottom:1rem;animation:float 3s ease-in-out infinite">ğŸ”®</div>
        <p style="color:rgba(255,255,255,0.65);margin-bottom:2rem;font-size:1.05rem">
            {% if language == 'ta' %}
            à®®à¯à®¤à®²à®¿à®²à¯ à®‰à®™à¯à®•à®³à¯ à®ªà®¿à®±à®¨à¯à®¤ à®µà®¿à®µà®°à®™à¯à®•à®³à¯ˆ à®®à¯à®•à®ªà¯à®ªà¯ à®ªà®•à¯à®•à®¤à¯à®¤à®¿à®²à¯ à®‰à®³à¯à®³à®¿à®Ÿà®µà¯à®®à¯
            {% else %}
            Enter your birth details on the home page first
            {% endif %}
        </p>
        <a href="/" style="display:inline-block;padding:1rem 2.5rem;
                   background:linear-gradient(135deg,#FFD700,#FF8C00);
                   color:#000;border-radius:50px;font-weight:700;
                   text-decoration:none;transition:all 0.3s;font-size:1rem">
            {% if language == 'ta' %}à®®à¯à®•à®ªà¯à®ªà¯ à®ªà®•à¯à®•à®®à¯{% else %}Go to Home{% endif %}
        </a>
    </div>

    {% else %}
    <!-- Card Display -->
    <div style="display:flex;flex-direction:column;align-items:center;gap:2rem">

        <canvas id="cosmicCard" width="540" height="720" style="border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,0.6),
                       0 0 40px rgba(255,215,0,0.15);max-width:100%;
                       animation:scaleIn 0.6s cubic-bezier(0.34,1.56,0.64,1)"></canvas>

        <div style="display:flex;gap:1rem;flex-wrap:wrap;justify-content:center">
            <button onclick="downloadCard()" style="padding:1rem 2.2rem;background:linear-gradient(135deg,#FFD700,#FF8C00);
                           color:#000;border:none;border-radius:50px;font-weight:700;
                           font-size:1rem;cursor:pointer;transition:all 0.3s;
                           display:inline-flex;align-items:center;gap:0.6rem">
                <i class="fas fa-download"></i>
                {% if language == 'ta' %}à®ªà®¤à®¿à®µà®¿à®±à®•à¯à®•à¯{% else %}Download{% endif %}
            </button>
            <button onclick="regenerateCard()" style="padding:1rem 2.2rem;background:rgba(255,215,0,0.1);
                           color:#FFD700;border:2px solid rgba(255,215,0,0.3);
                           border-radius:50px;font-weight:600;font-size:1rem;
                           cursor:pointer;transition:all 0.3s;
                           display:inline-flex;align-items:center;gap:0.6rem">
                <i class="fas fa-sync-alt"></i>
                {% if language == 'ta' %}à®ªà¯à®¤à¯à®ªà¯à®ªà®¿{% else %}Refresh{% endif %}
            </button>
        </div>

        <div style="text-align:center;max-width:400px">
            <p style="color:rgba(255,255,255,0.35);font-size:0.85rem;line-height:1.6">
                <i class="fas fa-share-alt" style="color:rgba(255,215,0,0.5)"></i>
                {% if language == 'ta' %}
                Instagram, WhatsApp à®…à®²à¯à®²à®¤à¯ Twitter à®‡à®²à¯ à®ªà®•à®¿à®°à®µà¯à®®à¯
                {% else %}
                Share on Instagram, WhatsApp, or Twitter
                {% endif %}
            </p>
        </div>
    </div>
    {% endif %}

</section>

<style>
    @keyframes float {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-10px);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes scaleIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
    }

    button:active {
        transform: translateY(-1px);
    }

    a:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
    }
</style>

{% if user_chart %}
<script>
    // â”€â”€ Chart data from Flask â”€â”€
    const CHART = {
        name: "{{ profile.name if profile else 'Cosmic Soul' }}",
        dob: "{{ profile.dob if profile else '' }}",
        rasiEn: "{{ user_chart.rasi.english_name if user_chart.rasi.english_name else user_chart.rasi.englishName }}",
        rasiTa: "{{ user_chart.rasi.tamil_name if user_chart.rasi.tamil_name else user_chart.rasi.tamilName }}",
        nakEn: "{{ user_chart.nakshatra.name }}",
        nakTa: "{{ user_chart.nakshatra.tamil_name if user_chart.nakshatra.tamil_name else user_chart.nakshatra.tamilName }}",
        pada: "{{ user_chart.nakshatra.pada }}",
        lord: "{{ user_chart.nakshatra.lord }}",
        lagna: "{{ user_chart.lagna.name }}",
        lang: "{{ language }}",
    };

    const LUCKY = {
        'Mesham': { color: '#FF4444', gem: 'Red Coral', day: 'Tuesday', num: 9 },
        'Rishabam': { color: '#44FF88', gem: 'Diamond', day: 'Friday', num: 6 },
        'Midhunam': { color: '#44BBFF', gem: 'Emerald', day: 'Wednesday', num: 5 },
        'Katakam': { color: '#EEEEFF', gem: 'Pearl', day: 'Monday', num: 2 },
        'Simmam': { color: '#FF8800', gem: 'Ruby', day: 'Sunday', num: 1 },
        'Kanni': { color: '#AAFFAA', gem: 'Emerald', day: 'Wednesday', num: 5 },
        'Thulam': { color: '#FFAAFF', gem: 'Diamond', day: 'Friday', num: 6 },
        'Viruchigam': { color: '#FF6666', gem: 'Red Coral', day: 'Tuesday', num: 9 },
        'Dhanusu': { color: '#FFDD44', gem: 'Yellow Sapphire', day: 'Thursday', num: 3 },
        'Makaram': { color: '#8888FF', gem: 'Blue Sapphire', day: 'Saturday', num: 8 },
        'Kumbam': { color: '#88AAFF', gem: 'Blue Sapphire', day: 'Saturday', num: 8 },
        'Meenam': { color: '#AAAAFF', gem: 'Yellow Sapphire', day: 'Thursday', num: 3 },
    };

    const RASI_SYMBOLS = {
        'Mesham': 'â™ˆ', 'Rishabam': 'â™‰', 'Midhunam': 'â™Š', 'Katakam': 'â™‹',
        'Simmam': 'â™Œ', 'Kanni': 'â™', 'Thulam': 'â™', 'Viruchigam': 'â™',
        'Dhanusu': 'â™', 'Makaram': 'â™‘', 'Kumbam': 'â™’', 'Meenam': 'â™“',
    };

    // â”€â”€ Draw Premium Card â”€â”€
    function drawCosmicCard() {
        const canvas = document.getElementById('cosmicCard');
        const ctx = canvas.getContext('2d');
        const W = canvas.width, H = canvas.height;
        const lucky = LUCKY[CHART.rasiEn] || { color: '#FFD700', gem: 'Pearl', day: 'Monday', num: 2 };
        const symbol = RASI_SYMBOLS[CHART.rasiEn] || 'â˜†';

        // â”€â”€ Background gradient â”€â”€
        const bgGrad = ctx.createLinearGradient(0, 0, W, H);
        bgGrad.addColorStop(0, '#0a0a1e');
        bgGrad.addColorStop(0.5, '#0f0f2a');
        bgGrad.addColorStop(1, '#060612');
        ctx.fillStyle = bgGrad;
        roundRect(ctx, 0, 0, W, H, 24);
        ctx.fill();

        // â”€â”€ Subtle star field â”€â”€
        ctx.save();
        for (let i = 0; i < 80; i++) {
            const x = Math.random() * W;
            const y = Math.random() * H;
            const r = Math.random() * 1.5;
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(255,255,255,${Math.random() * 0.4 + 0.05})`;
            ctx.fill();
        }
        ctx.restore();

        // â”€â”€ Gold border â”€â”€
        const borderGrad = ctx.createLinearGradient(0, 0, W, H);
        borderGrad.addColorStop(0, 'rgba(255,215,0,0.6)');
        borderGrad.addColorStop(0.5, 'rgba(255,140,0,0.3)');
        borderGrad.addColorStop(1, 'rgba(255,215,0,0.6)');
        ctx.strokeStyle = borderGrad;
        ctx.lineWidth = 3;
        roundRect(ctx, 6, 6, W - 12, H - 12, 20);
        ctx.stroke();

        // â”€â”€ Top glow â”€â”€
        const glowGrad = ctx.createRadialGradient(W / 2, 180, 0, W / 2, 180, 200);
        glowGrad.addColorStop(0, `${lucky.color}18`);
        glowGrad.addColorStop(1, 'transparent');
        ctx.fillStyle = glowGrad;
        ctx.fillRect(0, 0, W, 360);

        // â”€â”€ Brand header â”€â”€
        ctx.font = '700 14px sans-serif';
        ctx.fillStyle = 'rgba(255,215,0,0.5)';
        ctx.textAlign = 'center';
        ctx.letterSpacing = '4px';
        ctx.fillText('âœ¦ ASTROGUY AI âœ¦', W / 2, 45);

        // â”€â”€ Top divider â”€â”€
        ctx.strokeStyle = 'rgba(255,215,0,0.2)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(60, 60);
        ctx.lineTo(W - 60, 60);
        ctx.stroke();

        // â”€â”€ Name â”€â”€
        ctx.font = 'bold 32px Cinzel, serif';
        ctx.fillStyle = '#FFFFFF';
        ctx.textAlign = 'center';
        const displayName = CHART.name.toUpperCase();
        ctx.fillText(displayName, W / 2, 110);

        // â”€â”€ DOB â”€â”€
        if (CHART.dob) {
            ctx.font = '400 14px sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.fillText(CHART.dob, W / 2, 135);
        }

        // â”€â”€ Rasi symbol (large, colored) â”€â”€
        ctx.font = '80px serif';
        ctx.fillStyle = lucky.color;
        ctx.shadowColor = lucky.color;
        ctx.shadowBlur = 20;
        ctx.fillText(symbol, W / 2, 225);
        ctx.shadowBlur = 0;

        // â”€â”€ Rasi name â”€â”€
        ctx.font = 'bold 28px Cinzel, serif';
        ctx.fillStyle = lucky.color;
        ctx.fillText(CHART.lang === 'ta' ? CHART.rasiTa : CHART.rasiEn, W / 2, 270);

        ctx.font = '400 13px sans-serif';
        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        ctx.fillText('RASI (MOON SIGN)', W / 2, 290);

        // â”€â”€ Main info grid (clean cards) â”€â”€
        const infoY = 340;
        const infoItems = [
            { label: 'Nakshatra', value: CHART.lang === 'ta' ? CHART.nakTa : CHART.nakEn },
            { label: 'Pada', value: CHART.pada },
            { label: 'Lagna', value: CHART.lagna },
            { label: 'Lord', value: CHART.lord },
        ];

        const cols = 2;
        const cardW = 220;
        const cardH = 70;
        const gapX = 20;
        const startX = (W - (cardW * cols + gapX)) / 2;

        infoItems.forEach((item, i) => {
            const col = i % cols;
            const row = Math.floor(i / cols);
            const x = startX + col * (cardW + gapX);
            const y = infoY + row * (cardH + 15);

            // Card background
            ctx.fillStyle = 'rgba(255,255,255,0.04)';
            roundRect(ctx, x, y, cardW, cardH, 12);
            ctx.fill();

            ctx.strokeStyle = 'rgba(255,215,0,0.15)';
            ctx.lineWidth = 1.5;
            roundRect(ctx, x, y, cardW, cardH, 12);
            ctx.stroke();

            // Label
            ctx.font = '600 11px sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.textAlign = 'center';
            ctx.fillText(item.label.toUpperCase(), x + cardW / 2, y + 28);

            // Value
            ctx.font = 'bold 18px Cinzel, serif';
            ctx.fillStyle = '#FFD700';
            ctx.fillText(item.value, x + cardW / 2, y + 52);
        });

        // â”€â”€ Lucky elements section â”€â”€
        const luckyY = 540;

        ctx.strokeStyle = 'rgba(255,215,0,0.15)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(60, luckyY);
        ctx.lineTo(W - 60, luckyY);
        ctx.stroke();

        ctx.font = '700 12px sans-serif';
        ctx.fillStyle = 'rgba(255,215,0,0.5)';
        ctx.letterSpacing = '3px';
        ctx.textAlign = 'center';
        ctx.fillText('âœ¦ LUCKY ELEMENTS âœ¦', W / 2, luckyY + 25);

        const luckyItems = [
            { label: 'Gemstone', value: `ğŸ’ ${lucky.gem}`, icon: 'ğŸ’' },
            { label: 'Day', value: `ğŸ“… ${lucky.day}`, icon: 'ğŸ“…' },
            { label: 'Color', value: `â—`, color: lucky.color },
            { label: 'Number', value: `${lucky.num}`, num: true },
        ];

        const lY = luckyY + 55;
        const lCardW = 120;
        const lCardH = 60;
        const lGap = 15;
        const lStartX = (W - (lCardW * 2 + lGap * 3)) / 2;

        luckyItems.forEach((item, i) => {
            const col = i % 2;
            const row = Math.floor(i / 2);
            const x = lStartX + col * (lCardW + lGap * 2);
            const y = lY + row * (lCardH + 15);

            // Card
            ctx.fillStyle = 'rgba(255,255,255,0.03)';
            roundRect(ctx, x, y, lCardW, lCardH, 10);
            ctx.fill();

            // Label
            ctx.font = '400 10px sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.35)';
            ctx.textAlign = 'center';
            ctx.fillText(item.label.toUpperCase(), x + lCardW / 2, y + 20);

            // Value
            if (item.color) {
                ctx.beginPath();
                ctx.arc(x + lCardW / 2, y + 42, 10, 0, Math.PI * 2);
                ctx.fillStyle = item.color;
                ctx.fill();
                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.lineWidth = 2;
                ctx.stroke();
            } else if (item.num) {
                ctx.font = 'bold 20px Cinzel, serif';
                ctx.fillStyle = '#FFD700';
                ctx.fillText(item.value, x + lCardW / 2, y + 46);
            } else {
                ctx.font = '600 14px sans-serif';
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText(item.value, x + lCardW / 2, y + 44);
            }
        });

        // â”€â”€ Bottom footer â”€â”€
        const footY = H - 40;
        ctx.strokeStyle = 'rgba(255,215,0,0.15)';
        ctx.beginPath();
        ctx.moveTo(60, footY - 15);
        ctx.lineTo(W - 60, footY - 15);
        ctx.stroke();

        ctx.font = '400 11px sans-serif';
        ctx.fillStyle = 'rgba(255,255,255,0.25)';
        ctx.textAlign = 'center';
        ctx.fillText('astroguy.ai  â€¢  Authentic Vedic Astrology', W / 2, footY + 5);

        ctx.font = '400 10px sans-serif';
        ctx.fillStyle = 'rgba(255,215,0,0.3)';
        ctx.fillText(`Generated ${new Date().toLocaleDateString()}`, W / 2, footY + 22);
    }

    // â”€â”€ Helper: Rounded rectangle â”€â”€
    function roundRect(ctx, x, y, w, h, r) {
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.lineTo(x + w - r, y);
        ctx.quadraticCurveTo(x + w, y, x + w, y + r);
        ctx.lineTo(x + w, y + h - r);
        ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
        ctx.lineTo(x + r, y + h);
        ctx.quadraticCurveTo(x, y + h, x, y + h - r);
        ctx.lineTo(x, y + r);
        ctx.quadraticCurveTo(x, y, x + r, y);
        ctx.closePath();
    }

    function downloadCard() {
        const canvas = document.getElementById('cosmicCard');
        const link = document.createElement('a');
        link.download = `cosmic-card-${CHART.name.toLowerCase().replace(/\s+/g, '-')}.png`;
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
    }

    function regenerateCard() {
        drawCosmicCard();
    }

    // Draw on load
    window.addEventListener('load', drawCosmicCard);
</script>
{% endif %}
{% endblock %}